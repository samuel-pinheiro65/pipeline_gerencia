name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  JAVA_VERSION: '21'

jobs:
  # ============================================
  # ETAPA DE COMMIT: Build e Testes
  # ============================================
  build-and-test:
    name: Build e Testes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Dar permissÃ£o ao Gradle Wrapper
        run: chmod +x ./gradlew
      
      - name: Compilar aplicaÃ§Ã£o
        run: ./gradlew build -x test --no-daemon
      
      - name: Executar testes unitÃ¡rios
        run: ./gradlew test --tests "*unit*" --no-daemon
      
      - name: Executar testes de integraÃ§Ã£o
        run: ./gradlew test --tests "*integration*" --no-daemon
      
      - name: Publicar relatÃ³rio de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: build/reports/tests/test/
          retention-days: 30
      
      - name: Verificar build
        run: |
          if ! ls build/libs/*.jar 1> /dev/null 2>&1; then
            echo "âŒ Build falhou - JAR nÃ£o encontrado"
            exit 1
          fi
          echo "âœ… Build concluÃ­do com sucesso"
          echo "ğŸ“¦ Arquivos JAR encontrados:"
          ls -lh build/libs/*.jar

  # ============================================
  # ETAPA DE TESTE DE ACEITAÃ‡ÃƒO
  # ============================================
  acceptance-test:
    name: Teste de AceitaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Dar permissÃ£o ao Gradle Wrapper
        run: chmod +x ./gradlew
      
      - name: Executar testes de aceitaÃ§Ã£o
        run: ./gradlew test --tests "*acceptance*" --no-daemon
      
      - name: Publicar relatÃ³rio de aceitaÃ§Ã£o
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: acceptance-test-reports
          path: build/reports/tests/test/
          retention-days: 30
      
      - name: Validar teste de aceitaÃ§Ã£o
        run: |
          echo "âœ… Teste de aceitaÃ§Ã£o concluÃ­do"
          echo "Sistema validado nos nÃ­veis funcionais e nÃ£o funcionais"

  # ============================================
  # ETAPA DE LANÃ‡AMENTO: Deploy
  # ============================================
  deploy:
    name: Deploy da AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [build-and-test, acceptance-test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Dar permissÃ£o ao Gradle Wrapper
        run: chmod +x ./gradlew
      
      - name: Build da aplicaÃ§Ã£o
        run: ./gradlew clean build -x test --no-daemon
      
      - name: Listar artefatos gerados
        run: |
          echo "ğŸ“¦ Artefatos gerados:"
          ls -lh build/libs/
      
      - name: Preparar para deploy
        run: |
          echo "âœ… AplicaÃ§Ã£o pronta para deploy"
          echo "ğŸ“¦ JAR gerado em: build/libs/"
          echo ""
          echo "OpÃ§Ãµes de deploy:"
          echo "1. Docker: docker build -t pipeline-gerencia ."
          echo "2. Servidor: Execute o script scripts/deploy.sh"
      
      - name: Publicar artefato JAR
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: build/libs/*.jar
          retention-days: 7
      
      - name: Deploy com Docker (se disponÃ­vel)
        run: |
          if command -v docker &> /dev/null; then
            echo "ğŸ³ Construindo imagem Docker..."
            docker build -t pipeline-gerencia:${{ github.sha }} .
            docker tag pipeline-gerencia:${{ github.sha }} pipeline-gerencia:latest
            echo "âœ… Imagem Docker criada com sucesso"
            echo "Para executar: docker run -p 8080:8080 pipeline-gerencia:latest"
          else
            echo "âš ï¸ Docker nÃ£o disponÃ­vel neste runner"
            echo "âœ… Deploy pode ser feito manualmente usando o JAR gerado"
          fi

  # ============================================
  # RESUMO DO PIPELINE
  # ============================================
  pipeline-summary:
    name: Resumo do Pipeline
    runs-on: ubuntu-latest
    needs: [build-and-test, acceptance-test, deploy]
    if: always()
    
    steps:
      - name: Resumo da execuÃ§Ã£o
        run: |
          echo "=========================================="
          echo "ğŸ“Š RESUMO DO PIPELINE CI/CD"
          echo "=========================================="
          echo ""
          echo "âœ… Etapa de Commit: Build + Testes UnitÃ¡rios + Testes de IntegraÃ§Ã£o"
          echo "âœ… Etapa de Teste de AceitaÃ§Ã£o: ValidaÃ§Ã£o funcional e nÃ£o funcional"
          echo "âœ… Etapa de LanÃ§amento: Deploy automatizado"
          echo ""
          echo "ğŸ‰ Pipeline executado com sucesso!"

